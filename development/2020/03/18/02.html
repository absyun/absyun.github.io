<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.0 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>OIDC Login 구현해보기 Part-2 - 별거있나</title>
<meta name="description" content="사용할 IDP를 설정했으므로, 이제 본격적으로 User에게 Input을 받을 Frontend 그리고 최종적으로 인증을 완료하고 Token을 받게될 Backend를 구현해보기로 하자. ">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="별거있나">
<meta property="og:title" content="OIDC Login 구현해보기 Part-2">
<meta property="og:url" content="https://absyun.github.io/development/2020/03/18/02.html">


  <meta property="og:description" content="사용할 IDP를 설정했으므로, 이제 본격적으로 User에게 Input을 받을 Frontend 그리고 최종적으로 인증을 완료하고 Token을 받게될 Backend를 구현해보기로 하자. ">







  <meta property="article:published_time" content="2020-03-18T12:15:00+09:00">






<link rel="canonical" href="https://absyun.github.io/development/2020/03/18/02.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://absyun.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="별거있나 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--commenting_posts">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          별거있나
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <div class="archive">
    
      <h1 id="page-title" class="page__title">OIDC Login 구현해보기 Part-2</h1>
    
    <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161444856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161444856-1');
</script>

</head>

<p>사용할 IDP를 설정했으므로, 이제 본격적으로 User에게 Input을 받을 Frontend 그리고 최종적으로 인증을 완료하고 Token을 받게될 Backend를 구현해보기로 하자.</p>

<p>Frontend쪽은 React 기반의 Javascript, Backend쪽은 Gin 기반의 GO 언어를 이용해보려고 한다. 실제 Flow을 이해하고 나면 어떤 Framework, Language를 사용할지에 대한 건 큰 문제는 아니다.
구현하는 과정에서도 단순히 Curl 명령으로도 이를 수행할 수 있음을 짚고 넘어갈 것이다.</p>

<h2 id="idp로-인증-요청하기">IDP로 인증 요청하기</h2>

<p><img src="/assets/2020-03-18-02/3.PNG" alt="" /></p>

<p>이제부터 단계별로 진행 해나갈 FLOW 이다.
먼저 [Request static page]는 Browser로 Service하는 웹사이트에 접속하는 단계이므로 지금부터 진행할 단계에서는 생략하도록 하겠다.</p>

<p>여기서 IDP는 Part-1에서 Setup해둔 Keycloak이다.
Keycloak console에서 해당 Realm의 Endpoint 정보를 확인할 수 있다.
<img src="/assets/2020-03-18-02/1.PNG" alt="" />
<img src="/assets/2020-03-18-02/2.PNG" alt="" /></p>

<p>여기서 authorization_endpoint를 이용하여 IDP측에 로그인을 요청하자.
이는 Flow diagram에서 [Request authorization]에 해당한다.</p>

<p>Endpoint는 확인된 바로 [http://localhost:8080/auth/realms/master/protocol/openid-connect/auth] 이렇게 된다.</p>

<p>여기에 필수로 넣어야할 Parameter들을 추가하자.</p>
<blockquote>
  <p>client_id : Part-1에서 oidc-test로 설정하였다.</p>

  <p>response_type : code, 이건 회신받을 type으로 여기선 code로 설정한다.</p>

  <p>redirect_uri : http://localhost (일단 준비된 web 사이트가 없으니 아무거나…)</p>

  <p>state : 12345 (아무 값이나..)</p>
</blockquote>

<p>그럼 최종적으로 완성된 URL은 아래와 같다.</p>
<blockquote>
  <p>http://localhost:8080/auth/realms/master/protocol/openid-connect/auth?response_type=code&amp;client_id=oidc-test&amp;redirect_uri=http://localhost&amp;state=12345</p>
</blockquote>

<p>먼저 Keycloak console 화면에서 Manage -&gt; Users -&gt; Sessions -&gt; oidc-test 에 Session이 존재할 경우 Logout all로 날려주자.</p>

<p>그리고 완성된 URL을 Browser 주소창에 입력해보자.
<img src="/assets/2020-03-18-02/4.PNG" alt="" /></p>

<p>아래와 같이 나온다면 Keycloak으로 로그인 요청이 정상적으로 들어간 것이다.</p>

<p>이제 실제로 웹사이트에서 Redirect하는 형태로 구현해보자.</p>

<p>[Entry point]</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">./App.css</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">Login</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./views/auth/Login</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">Authorizing</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./views/auth/Authorizing</span><span class="dl">"</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">BrowserRouter</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">Route</span> <span class="nx">exact</span><span class="o">=</span><span class="p">{</span><span class="kc">true</span><span class="p">}</span> <span class="nx">path</span><span class="o">=</span><span class="dl">"</span><span class="s2">/authorizing</span><span class="dl">"</span> <span class="nx">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Authorizing</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="nx">Route</span> <span class="nx">exact</span><span class="o">=</span><span class="p">{</span><span class="kc">true</span><span class="p">}</span> <span class="nx">path</span><span class="o">=</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="nx">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Login</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/BrowserRouter</span><span class="err">&gt;
</span>    <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">App</span><span class="p">;</span>
</code></pre></div></div>
<p>웹사이트 진입시 나타나는 Page를 rendering하는 코드이다.
역할은 간단하다, 그냥 root path, authorizing path를 Routing rule로 설정하고 진입시 root 이므로 Login 컴포넌트로 연결해준다.</p>

<hr />

<p>[Login requset]</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useEffect</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Login</span><span class="p">()</span> <span class="p">{</span>
  
  <span class="nx">useEffect</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:8080/auth/realms/master/protocol/openid-connect/auth?response_type=code&amp;client_id=oidc-test&amp;redirect_uri=http://172.22.130.112:3000/authorizing&amp;state=12345</span><span class="dl">"</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="nx">Let</span><span class="dl">'</span><span class="s1">s go to the IDP
    &lt;/div&gt;
  )
}
</span></code></pre></div></div>
<p>Login으로 진입 후 화면에 [Let’s go to the IDP] 문구를 출력하고 설정된 URL로 Browser 주소를 이동시킨다.
URL에 넘어가는 Parameter는 위에서 설명한 바와 같고 Redirect URL이 달라진 이유는 WSL2 특성으로 인해 Local이긴하지만 WSL2의 네트워크 주소가 별도로 생기기 때문에 그게 맞는 주소를 입력한 것이다. 동일한 Local환경에서 테스트할 경우 localhost:3000… 이 될 것이다. IDP 인증 후에는 authorizing path로 keycloak이 Redirect해주게 된다.</p>

<blockquote>
  <p>참고로 초기에 Keycloak에 설정해두었던 Vaild Redirect &gt;URIs도 이에 맞게 수정해두어야한다.
<img src="/assets/2020-03-18-02/5.PNG" alt="" /></p>
</blockquote>

<hr />

<p>[Redirected]</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Authorizing</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
  
  <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="nx">Redirected</span>
      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">)</span> 
<span class="p">}</span>
</code></pre></div></div>
<p><img src="/assets/2020-03-18-02/6.PNG" alt="" /></p>
<blockquote>
  <p>state=12345&amp;session_state=2985896d-89e4-4475-99b0-de8dec99f40c&amp;code=e3d67040-4b03-4461-bbf3-ead1e261106d.2985896d-89e4-4475-99b0-de8dec99f40c.f9290787-76ef-4c5d-bf96-57b0e6568646</p>
</blockquote>

<p>IDP 화면에서 ID, Password를 입력해주게 되면 Parameter로 입력된 Redirect URL로 Page가 이동된다. 위에 console.log로 출력하는 Params이 이미지에 나타난 내용이며 IDP에서 로그인을 성공했으므로 전달해주는 값이다.</p>

<blockquote>
  <p>state: 먼저 전달해준 값이 그대로 넘어온다. 이는 본인이 요청한 Request가 맞는 지 재확인하는 용도로 사용된다.</p>

  <p>session_state: IDP에서 넘겨주는 값으로 client id, origin url, browser state 값들을 활용해서 만드는 key값 같은 것으로 추가 로그인 과정에서 특별히 사용하지는 않았다.</p>

  <p>code: 해당 코드를 가지고 추후 backend 측에서 Token을 요청한다.</p>
</blockquote>

<p>실제 Token을 받게되는 backend 측의 동작에 대해서는 다음 Part에서 정리해보도록 하겠다.</p>



<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://absyun.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


<ul class="taxonomy__index">
  
  
    <li>
      <a href="#2020">
        <strong>2020</strong> <span class="taxonomy__count">7</span>
      </a>
    </li>
  
</ul>



  <section id="2020" class="taxonomy__section">
    <h2 class="archive__subtitle">2020</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/development/2020/03/18/03.html" rel="permalink">OIDC Login 구현해보기 Part-3
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">앞서 Part에서 Frontend 측에서 Browser를 통해 IDP를 거쳐 code를 받는 것 까지 진행되었다. Confidential Type의 인증은 최종적으로 Secret을 이용하여 access token을 받게 되는 데 이 Secret은 Backend 에서 보관하고 있는 ...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/development/2020/03/18/02.html" rel="permalink">OIDC Login 구현해보기 Part-2
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">사용할 IDP를 설정했으므로, 이제 본격적으로 User에게 Input을 받을 Frontend 그리고 최종적으로 인증을 완료하고 Token을 받게될 Backend를 구현해보기로 하자.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/development/2020/03/18/01.html" rel="permalink">OIDC Login 구현해보기 Part-1
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">OIDC…
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/environment/2020/03/15/04.html" rel="permalink">WSL2 … and Docker
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">WSL + VSCODE의 조합으로 많은 것들을 편리한 환경에서 수행해 올 수 있었다. 하지만 WSL에서 아쉬움으로 와 닿았던 것… 바로 Docker 실행이다. 초반에는 Docker를 포기하고 준비된 환경안에서 할 수 있는 것들에 만족해 왔지만…
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/environment/2020/03/15/03.html" rel="permalink">Visual studio code + WSL
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Windows 10 바탕에 WSL 기반으로 개발 환경을 셋팅하고, 본격적 사용을 하다보면 불편한 점이 바로 나타난다.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/environment/2020/03/15/02.html" rel="permalink">Github sshkey로 계정 연결하기
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Github sshkey로 계정 연결하기
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/environment/2020/03/15/01.html" rel="permalink">Windows 10 WSL
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">WSL (Windows Subsystem for Linux)
</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to Top &uarr;</a>
  </section>


  </div>
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 별거있나. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
