<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>GSON - Composite pattern class</title>
  <meta name="description" content="GSON">
  
  <meta name="author" content="absyun">
  <meta name="copyright" content="&copy; absyun 2020">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  

  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="absyun.github.io/development/2020/04/19/composite_gson.html">
	<link rel="alternate" type="application/rss+xml" title="별거있나" href="absyun.github.io/feed.xml" />
	
	<!-- Tooltips -->
	<script type="text/javascript">
		window.tooltips = []
	</script>
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      <span>HOME</span>
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161444856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161444856-1');
</script>

</head>

<div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">GSON - Composite pattern class</h1>
      <p class="info">by <strong></strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">April 19, 2020</div>
  <div class="post-categories">
  in 
    
    <a href="/category/Development">Development</a>
    
  
  </div>
</section>

<article class="post-content">
  <h1 id="gson">GSON</h1>

<p><a href="https://github.com/google/gson">https://github.com/google/gson</a> <br />
Google에서 내어놓은 open source library이다, 용도는 간단하다.</p>
<h3 id="java-class-object---json">java class object &lt;-&gt; json</h3>

<p>json은 워낙 유명한 데이터 저장 포멧이므로 특별히 설명은 하지 않으려고 한다.
java에서는 기본적으로 serialize(직렬화)라는 기능이 제공되어진다. 이 기능은 java object를 dump를 뜨는 것 처럼 그대로 byte 포멧으로 바꾸어주고, 다시 역직렬화도 가능하다.
다만 여러 제약사항이 존재하는 데, deserialize로만 복원이 가능하며 class가 가진 맴버 변수들의 변화에 민감해서 장기 저장용이나 serialize하는 곳과 deserialize하는 곳이 분리되어서 별도로 운영되어 진다면 이를 맞추어 관리하는 것도 상당히 불편한다.</p>

<p>그래서 현재 개인적으로 진행하는 작은 프로젝트에서 특정 class 정보를 간단히 저장하고, 프로그램 재시작시 다시 class 형태로 복원을 하고자 하는 데, 아래와 같은 이유로 gson을 채택하기로 마음 먹었다.</p>

<ol>
  <li>저장 포멧이 text의 json 타입이므로 어디로든 Persistent로의 저장이 간편하다.</li>
  <li>json 타입이므로 혹여 java가 아닌 다른 언어로도 해당 정보를 복원할 수 있다.</li>
  <li>Serialize 처럼 class의 instance 자체를 통으로 저장하고, 복원할 수 있어서 간편하다.</li>
</ol>

<p>저장을 하고자하는 class는 아래에서 Composite pattern을 이용해서 만들었던 Rule set이다.</p>
<blockquote>
  <p><a href="/development/2020/04/18/designpattern_composite.html">Design pattern - Composite pattern</a></p>

  <p><em>[아래부터 진행될 내용은 위 posting의 연장선상에서 진행되므로, 사용할 class의 구조와 이해도를 위해서 한번 읽어주시기를 권장드립니다.]</em></p>
</blockquote>

<h2 id="library-import">Library import</h2>

<p>해당 프로젝트는 우선 Android에서 사용되어질 프로젝트라서 Gradle build를 사용 중이므로 dependancy를 추가해주자.</p>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'com.google.code.gson:gson:2.8.6'</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="serialize">Serialize</h2>

<p>기본적으로 recursive object 참조가 없다면 encoding은 간단하다.
먼저 앞선 posting에서 만들어둔 class들을 조합하여 object하나를 생성해보자.
Ruleset을 만들어줄 function 이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="nc">IRule</span> <span class="nf">getRuleSet1</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">RuleGroup</span> <span class="n">mainRule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleGroup</span><span class="o">();</span>
    <span class="n">mainRule</span><span class="o">.</span><span class="na">setAndConnection</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="nc">RuleGroup</span> <span class="n">subRule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleGroup</span><span class="o">();</span>
    <span class="n">subRule</span><span class="o">.</span><span class="na">setAndConnection</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="nc">RuleMsg</span> <span class="n">msg1Rule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleMsg</span><span class="o">();</span>
    <span class="n">msg1Rule</span><span class="o">.</span><span class="na">setMsg</span><span class="o">(</span><span class="s">"삼성카드"</span><span class="o">);</span>
    <span class="n">msg1Rule</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">RuleMsg</span><span class="o">.</span><span class="na">CHECK_TYPE</span><span class="o">.</span><span class="na">CONTAIN</span><span class="o">);</span>
    <span class="n">subRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">msg1Rule</span><span class="o">);</span>
    <span class="nc">RuleMsg</span> <span class="n">msg2Rule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleMsg</span><span class="o">();</span>
    <span class="n">msg2Rule</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">RuleMsg</span><span class="o">.</span><span class="na">CHECK_TYPE</span><span class="o">.</span><span class="na">CONTAIN</span><span class="o">);</span>
    <span class="n">msg2Rule</span><span class="o">.</span><span class="na">setMsg</span><span class="o">(</span><span class="s">"삼성 카드"</span><span class="o">);</span>
    <span class="n">subRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">msg2Rule</span><span class="o">);</span>

    <span class="n">mainRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">subRule</span><span class="o">);</span>

    <span class="nc">RuleMsg</span> <span class="n">msg3Rule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleMsg</span><span class="o">();</span>
    <span class="n">msg3Rule</span><span class="o">.</span><span class="na">setMsg</span><span class="o">(</span><span class="s">"승인"</span><span class="o">);</span>
    <span class="n">msg3Rule</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">RuleMsg</span><span class="o">.</span><span class="na">CHECK_TYPE</span><span class="o">.</span><span class="na">CONTAIN</span><span class="o">);</span>
    <span class="n">mainRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">msg3Rule</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">mainRule</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>return 되는 mainRule은 간략히 아래와 같은 구조를 갖게된다.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">MainRule</span><span class="pi">:</span> <span class="s">RuleGroup</span>
    <span class="s">- isAndCondition</span> <span class="pi">:</span> <span class="s">bool</span>
    <span class="s">- rules</span> <span class="pi">:</span> <span class="s">IRule[]</span>
        <span class="s">- subRule</span> <span class="pi">:</span> <span class="s">RuleGroup</span>
            <span class="s">- isAndCondition</span> <span class="pi">:</span> <span class="s">bool</span>
            <span class="s">- rules</span> <span class="pi">:</span> <span class="s">IRule[]</span>
                <span class="s">- msg1Rule</span> <span class="pi">:</span> <span class="s">MsgRule</span>
                    <span class="s">- text</span> <span class="pi">:</span> <span class="s">String</span>
                    <span class="s">- check_type</span> <span class="pi">:</span> <span class="s">enum</span>
                <span class="s">- msg2Rule</span> <span class="pi">:</span> <span class="s">MsgRule</span>
                    <span class="s">- text</span> <span class="pi">:</span> <span class="s">String</span>
                    <span class="s">- check_type</span> <span class="pi">:</span> <span class="s">enum</span>
        <span class="s">- msg3Rule</span> <span class="pi">:</span> <span class="s">MsgRule</span>
            <span class="s">- text</span> <span class="pi">:</span> <span class="s">String</span>
            <span class="s">- check_type</span> <span class="pi">:</span> <span class="s">enum</span>
</code></pre></div></div>

<p>gson으로 Serialize해보자</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Gson</span> <span class="n">engson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
<span class="nc">IRule</span> <span class="n">ruleSet1</span> <span class="o">=</span> <span class="nc">RuleSetGenerator</span><span class="o">.</span><span class="na">getRuleSet1</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">engson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">,</span> <span class="nc">RuleGroup</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
</code></pre></div></div>
<p>출력되는 text를 json 포멧으로 좀 보기좋게 나열하면 아래와 같다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_group"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rules"</span><span class="p">:[</span><span class="w"> 
        </span><span class="p">{</span><span class="w"> 
            </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_group"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"rules"</span><span class="p">:[</span><span class="w"> 
                </span><span class="p">{</span><span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">번</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_msg"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"check_type"</span><span class="p">:</span><span class="s2">"CONTAIN"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"text"</span><span class="p">:</span><span class="s2">"삼성카드"</span><span class="w">
                </span><span class="p">},</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="mi">2</span><span class="err">번</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_msg"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"check_type"</span><span class="p">:</span><span class="s2">"CONTAIN"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"text"</span><span class="p">:</span><span class="s2">"삼성 카드"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"isAndConnection"</span><span class="p">:</span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_msg"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"check_type"</span><span class="p">:</span><span class="s2">"CONTAIN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"text"</span><span class="p">:</span><span class="s2">"승인"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"isAndConnection"</span><span class="p">:</span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>아주 간단하게 key값은 variable name이 되고 value는 해당 값으로 … json 포멧으로 변형이 되었다. 아주 심플하고 쓰기 좋군요! 짝짝!!</p>

<h2 id="deserialize">Deserialize</h2>

<p>자 이제 이를 반대로 deserialize해보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">engson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="nc">Unable</span> <span class="n">to</span> <span class="n">invoke</span> <span class="n">no</span><span class="o">-</span><span class="n">args</span> <span class="n">constructor</span> <span class="k">for</span> <span class="kd">interface</span> <span class="nc">com</span><span class="o">.</span><span class="na">absyun</span><span class="o">.</span><span class="na">msgsecretary</span><span class="o">.</span><span class="na">job</span><span class="o">.</span><span class="na">IRule</span><span class="o">.</span> <span class="nc">Registering</span> <span class="n">an</span> <span class="nc">InstanceCreator</span> <span class="n">with</span> <span class="nc">Gson</span> <span class="k">for</span> <span class="k">this</span> <span class="n">type</span> <span class="n">may</span> <span class="n">fix</span> <span class="k">this</span> <span class="n">problem</span><span class="o">.</span>
</code></pre></div></div>

<p>아래와 같은 에러가 발생한다. 어찌보면 당연한 현상일 수 있다.</p>

<p>Serialize하는 단계에서는 RuleGroup이 갖고있는 member variable의 list안에 instance들이 IRule이라는 interface로 추상화 되어있긴 하지만, 실제 implements된 class들의 instance들이다. 그러므로 Memory에 올라와 있는 값들을 class member meta 정보와 함께 json 포멧으로 만들기만 하면 된다. 하지만 반대의 경우 Deserialize 단계에서 IRule에 매핑을 하려고 하면 1, 2번들이 어떠한 class로 매핑되어야할 지에 대한 정보가 없다. 이렇게 Polymorphism을 이용해서 구현되어진 class들은 모두 유사한 문제에 당면할 수 밖에 없는 것이다.</p>

<p>이 상황을 해결하기 위해서 의도적으로 만들어둔게 IRule interface를 구현한 class들이 type(class 소스는 위 posting을 참조하자)을 갖도록 했다. 이 값을 이용해서 어떠한 class로 복원할지를 결정할 수 있도록 할 것이다.</p>

<p>gson의 경우 custom type의 deserialize 기능도 제공이 된다. 물론 반대도 지원하지만 현 상황에서는 굳이 필요는 없다.</p>

<hr />

<p>RuleDeserializer.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RuleDeserializer</span> <span class="kd">implements</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="nc">IRule</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">registerTypeAdapter</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">).</span><span class="na">create</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;&gt;</span> <span class="n">ruleTypeClass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;&gt;(){</span>
        <span class="o">{</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_MSG</span><span class="o">,</span> <span class="nc">RuleMsg</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_SENDER</span><span class="o">,</span> <span class="nc">RuleSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_GROUP</span><span class="o">,</span> <span class="nc">RuleGroup</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">IRule</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">JsonElement</span> <span class="n">json</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">typeOfT</span><span class="o">,</span> <span class="nc">JsonDeserializationContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonParseException</span> <span class="o">{</span>
        <span class="nc">JsonObject</span> <span class="n">ruleObject</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">();</span>
        <span class="nc">JsonElement</span> <span class="n">eType</span> <span class="o">=</span> <span class="n">ruleObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"type"</span><span class="o">);</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;</span> <span class="n">cType</span> <span class="o">=</span> <span class="n">ruleTypeClass</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eType</span><span class="o">.</span><span class="na">getAsString</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">cType</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<hr />

<p>구현 해본 CustomDeserializer이다.</p>

<p>하나하나 뜯어서 살펴보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">registerTypeAdapter</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">).</span><span class="na">create</span><span class="o">();</span>
</code></pre></div></div>
<p>먼저 해당 CustomDeserializer는 자체 gson object를 갖고있다.
이를 이용해서 내부 deserialize를 시도하게 된다. 처음 위에서 serialize 할 때의 gson object 와의 차이점을 보면 registerTypeAdapter를 이용해서 custom adapter를 설정해주었다. IRule.class를 deserialze할 경우 ‘this’ 본 클래스를 사용하라는 의미이다. 이는 제일 밑에서 한번 더 설명하도록 하겠다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;&gt;</span> <span class="n">ruleTypeClass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;&gt;(){</span>
        <span class="o">{</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_MSG</span><span class="o">,</span> <span class="nc">RuleMsg</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_SENDER</span><span class="o">,</span> <span class="nc">RuleSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">put</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">TYPE_GROUP</span><span class="o">,</span> <span class="nc">RuleGroup</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre></div></div>
<p>기본 member 변수로 Map을 만들어서 각 Rule type별로 어떠한 class를 사용하여 deserialize를 할지를 매핑 해두었다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">IRule</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">JsonElement</span> <span class="n">json</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">typeOfT</span><span class="o">,</span> <span class="nc">JsonDeserializationContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonParseException</span> <span class="o">{</span>
        <span class="nc">JsonObject</span> <span class="n">ruleObject</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">();</span>
        <span class="nc">JsonElement</span> <span class="n">eType</span> <span class="o">=</span> <span class="n">ruleObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"type"</span><span class="o">);</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">IRule</span><span class="o">&gt;</span> <span class="n">cType</span> <span class="o">=</span> <span class="n">ruleTypeClass</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eType</span><span class="o">.</span><span class="na">getAsString</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">cType</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>마지막으로 해당 interface인 JsonDeserializer<T>를 implements하기 위해 구현한 method이다. 파라메터로 전달되는 object에서 type 값을 가져온 다음, type에 매핑되는 class를 Map에서 확인한 후, 해당 class로 deserialize를 하는 과정이다.</T></p>

<p>좀 복잡한 개념이 될 수도 있는 데, deserialize 하는 type이 만약 RuleGroup이 될 경우 이 RuleGroup은 내부에 member로 IRule list를 갖고 있기 때문에 여기서 사용되는 gson또한 IRule을 Deserialize할 수 있는 custom adapter를 알고 있어야 한다.
그래서 초기에 member변수로 gson을 생성시 this를 adapter로 연결해주는 것이다.</p>

<p>그럼 동작시켜보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Gson</span> <span class="n">engson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
<span class="nc">IRule</span> <span class="n">ruleSet1</span> <span class="o">=</span> <span class="nc">RuleSetGenerator</span><span class="o">.</span><span class="na">getRuleSet1</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">engson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">,</span> <span class="nc">RuleGroup</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>

<span class="nc">Gson</span> <span class="n">degson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">registerTypeAdapter</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RuleDeserializer</span><span class="o">()).</span><span class="na">create</span><span class="o">();</span>
<span class="nc">IRule</span> <span class="n">result</span> <span class="o">=</span> <span class="n">degson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>
<p>이제 IRuled을 deserialize 할 수 있는 gson을 새로 생성하겠다. customAdapter로 앞서 만들어둔 class를 파라메터로 전달하자 ‘new RuleDeserializer()’.</p>

<p>fromJson method가 이제는 Error를 발생시키지 않고 정상적으로 동작함을 확인할 수 있다.</p>

<p>Error는 발생하지 않지만, 실제로 정상적으로 Deserialize가 성공했는 지 확인해보기 위해, 앞서 posting에서 만들어둔 Rule check 코드를 재사용해보겠다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nc">Gson</span> <span class="n">engson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
        <span class="nc">IRule</span> <span class="n">ruleSet1</span> <span class="o">=</span> <span class="nc">RuleSetGenerator</span><span class="o">.</span><span class="na">getRuleSet1</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 수락"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성카드 취소"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 취소"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"현대 카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"카드취소"</span><span class="o">));</span>

        <span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">engson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">ruleSet1</span><span class="o">,</span> <span class="nc">RuleGroup</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Gson</span> <span class="n">degson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">registerTypeAdapter</span><span class="o">(</span><span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RuleDeserializer</span><span class="o">()).</span><span class="na">create</span><span class="o">();</span>

        <span class="nc">IRule</span> <span class="n">result</span> <span class="o">=</span> <span class="n">degson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 수락"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성카드 취소"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"삼성 카드 취소"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"현대 카드 승인"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"카드취소"</span><span class="o">));</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>true
true
false
false
false
false
false

true
true
false
false
false
false
false
</code></pre></div></div>

<p>serialize 전, 후의 결과값과 같이 동일함을 알 수 있다.
이제 Composite pattern으로 만들어둔 Rule set object를 text 타입의 json 포멧으로 serialize 후 다시 deserialize를 거쳐 정상적으로 동일 object로 복원하는 과정을 완성하였다.</p>

<h2 id="-gson의-내부동작">+ GSON의 내부동작</h2>

<p>추가적으로 재미있는 테스트를 해보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="nc">IRule</span> <span class="nf">getRuleSet3</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">RuleGroup</span> <span class="n">mainRule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleGroup</span><span class="o">();</span>
    <span class="n">mainRule</span><span class="o">.</span><span class="na">setAndConnection</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="nc">RuleSender</span> <span class="n">senderRule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuleSender</span><span class="o">();</span>
    <span class="n">senderRule</span><span class="o">.</span><span class="na">setSender</span><span class="o">(</span><span class="s">"01012345678"</span><span class="o">);</span>

    <span class="n">mainRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">senderRule</span><span class="o">);</span>
    <span class="n">mainRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">senderRule</span><span class="o">);</span>
    <span class="n">mainRule</span><span class="o">.</span><span class="na">addRule</span><span class="o">(</span><span class="n">senderRule</span><span class="o">);</span>

    <span class="n">senderRule</span><span class="o">.</span><span class="na">setSender</span><span class="o">(</span><span class="s">"01087654321"</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">mainRule</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>사실 이렇게 사용하는 경우는 없을 태지만 GSON 내부 동작을 보기위한 테스트 이다.</p>

<p>하나의 instance를 여러번 Ruleset array에 넣었다.
이렇게 하면 하나의 instance인 RuleSender가 RuleGroup.rules Array안에서 여러번 참조되는 형태가 된다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_group"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rules"</span><span class="p">:[</span><span class="w"> 
        </span><span class="p">{</span><span class="w"> 
            </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_sender"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"match"</span><span class="p">:</span><span class="s2">"01087654321"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> 
            </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_sender"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"match"</span><span class="p">:</span><span class="s2">"01087654321"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> 
            </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"type_sender"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"match"</span><span class="p">:</span><span class="s2">"01087654321"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"isAndConnection"</span><span class="p">:</span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>이 Ruleset 보면 마지막에 한번 sender 값만 바꾸었지만, 하나의 instance이기 때문에 모두 변한 것을 볼 수 있다. 이 Rule을 Serialize -&gt; Deserialize를 거치면 어떻게 될까?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IRule</span> <span class="n">test</span> <span class="o">=</span> <span class="n">degson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="nc">IRule</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="k">for</span><span class="o">(</span><span class="nc">IRule</span> <span class="n">r</span> <span class="o">:</span> <span class="o">((</span><span class="nc">RuleGroup</span><span class="o">)</span><span class="n">test</span><span class="o">).</span><span class="na">getRules</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
<span class="o">}</span>

<span class="o">---</span>
<span class="mi">1654589030</span>
<span class="mi">466002798</span>
<span class="mi">33524623</span>
</code></pre></div></div>

<p>결과는 각 Sender가 각각의 개체가 된다.
각 Object의 hashCode를 출력해보면 다른 값이 나옴을 확인할 수 있다.</p>

<p>이러한 특성 때문에 복잡한 class object 안에서 공유되는 object들이 있는 instance를 Serialize, Deserialize할 경우 기대하는 형태로 복원이 안될 수 있기 때문의 주의하여야 한다.</p>

<p>위와 같은 몇가지 제약사항은 존재하지만, 분명 GSON은 지원하는 범위내에서의 class object를 저장 및 복원하는 용도로 쓰기에 매력적인 library임에는 틀림이 없는 것 같다.</p>


</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/gson">gson</a>,&nbsp;<a href="/tag/composite pattern">composite pattern</a>,&nbsp;<a href="/tag/android">android</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
    
    
    
    
    
    
  
</section>


<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://absyun.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">별거있나</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:tjln0608@gmail.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">tjln0608@gmail.com</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://github.com/absyun" title="GitHub">
              <i class="fa fa-github"></i>
              <span class="username">absyun</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">A simple yet classy theme for your Jekyll website or blog.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
<script src="//unpkg.com/popper.js@1"></script>
<script src="//unpkg.com/tippy.js@5"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });

	// Enable tooltips via Tippy.js
	if (Array.isArray(window.tooltips)) {
		window.tooltips.forEach(function(tooltip) {
			var selector = tooltip[0];
			var config = tooltip[1];
			tippy(selector, config);
		})
	}
});

</script>






  </body>

</html>
